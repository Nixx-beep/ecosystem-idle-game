<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecosystem Idle - Nature Growth Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2d3748;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #2d5016;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .subtitle {
            text-align: center;
            color: #5a6c57;
            margin-bottom: 30px;
            font-style: italic;
        }

        /* Auth Modal Styles */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .auth-modal.active {
            display: flex;
        }

        .auth-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            max-width: 400px;
            width: 90%;
        }

        .auth-box h2 {
            color: #2d5016;
            margin-bottom: 20px;
            text-align: center;
        }

        .auth-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
        }

        .auth-input:focus {
            outline: none;
            border-color: #68d391;
        }

        .auth-button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #68d391 0%, #48bb78 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1em;
            margin-bottom: 10px;
        }

        .auth-button:hover {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .auth-toggle {
            text-align: center;
            margin-top: 15px;
            color: #718096;
        }

        .auth-toggle a {
            color: #48bb78;
            cursor: pointer;
            text-decoration: none;
        }

        .auth-toggle a:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        .success-message {
            background: #c6f6d5;
            color: #22543d;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        /* User Info Bar */
        .user-bar {
            background: #f7fafc;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid #e2e8f0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-email {
            font-weight: 600;
            color: #2d5016;
        }

        .cloud-status {
            font-size: 0.9em;
            color: #718096;
        }

        .cloud-status.saving {
            color: #ed8936;
        }

        .cloud-status.saved {
            color: #38a169;
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .small-button {
            padding: 8px 16px;
            background: #e2e8f0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            color: #2d3748;
            transition: all 0.3s ease;
        }

        .small-button:hover {
            background: #cbd5e0;
        }

        .small-button.danger {
            background: #fc8181;
            color: white;
        }

        .small-button.danger:hover {
            background: #f56565;
        }

        .game-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: #f7fafc;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #e2e8f0;
        }

        .panel h2 {
            color: #2d5016;
            margin-bottom: 15px;
            font-size: 1.4em;
            border-bottom: 2px solid #68d391;
            padding-bottom: 8px;
        }

        .resource {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #68d391;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .resource-name {
            font-weight: 600;
            color: #2d5016;
        }

        .resource-value {
            font-weight: bold;
            color: #38a169;
            font-size: 1.1em;
        }

        .resource-rate {
            font-size: 0.85em;
            color: #718096;
            margin-left: 8px;
        }

        .building, .upgrade {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .building:hover, .upgrade:hover {
            border-color: #68d391;
            box-shadow: 0 4px 12px rgba(104, 211, 145, 0.2);
        }

        .building.disabled, .upgrade.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .building.disabled:hover, .upgrade.disabled:hover {
            border-color: #e2e8f0;
            box-shadow: none;
        }

        .building-header, .upgrade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .building-name, .upgrade-name {
            font-weight: 600;
            color: #2d5016;
            font-size: 1.1em;
        }

        .building-count {
            background: #68d391;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
        }

        .building-description, .upgrade-description {
            font-size: 0.9em;
            color: #4a5568;
            margin-bottom: 8px;
        }

        .building-cost, .upgrade-cost {
            font-size: 0.85em;
            color: #718096;
            margin-bottom: 8px;
        }

        .building-production {
            font-size: 0.85em;
            color: #38a169;
            font-weight: 600;
        }

        button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #68d391 0%, #48bb78 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
        }

        button:hover:not(:disabled) {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
        }

        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .prestige-panel {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            color: white;
            grid-column: 1 / -1;
            text-align: center;
            padding: 25px;
        }

        .prestige-panel h2 {
            color: white;
            border-bottom-color: rgba(255, 255, 255, 0.3);
        }

        .prestige-info {
            font-size: 1.1em;
            margin: 15px 0;
        }

        .prestige-button {
            background: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%);
            max-width: 300px;
            margin: 15px auto 0;
        }

        .prestige-button:hover:not(:disabled) {
            background: linear-gradient(135deg, #3f5efb 0%, #fc466b 100%);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: #e2e8f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(135deg, #68d391 0%, #48bb78 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #805ad5;
        }

        .stat-label {
            font-size: 0.9em;
            color: #718096;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #553c9a;
        }

        .achievement {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #f6ad55;
            opacity: 0.5;
        }

        .achievement.unlocked {
            opacity: 1;
            border-left-color: #ed8936;
        }

        .achievement-name {
            font-weight: 600;
            color: #c05621;
            margin-bottom: 5px;
        }

        .achievement-desc {
            font-size: 0.9em;
            color: #4a5568;
        }

        @media (max-width: 1024px) {
            .game-grid {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Auth Modal -->
    <div id="auth-modal" class="auth-modal active">
        <div class="auth-box">
            <h2 id="auth-title">Welcome to Ecosystem Idle</h2>
            <div id="error-message" class="error-message"></div>
            <div id="success-message" class="success-message"></div>
            
            <div id="login-form">
                <input type="email" id="login-email" class="auth-input" placeholder="Email" />
                <input type="password" id="login-password" class="auth-input" placeholder="Password" />
                <button class="auth-button" onclick="login()">Login</button>
                <div class="auth-toggle">
                    Don't have an account? <a onclick="showSignup()">Sign up</a>
                </div>
                <div class="auth-toggle" style="margin-top: 10px;">
                    <a onclick="playAsGuest()">Play as Guest (local save only)</a>
                </div>
            </div>

            <div id="signup-form" class="hidden">
                <input type="email" id="signup-email" class="auth-input" placeholder="Email" />
                <input type="password" id="signup-password" class="auth-input" placeholder="Password (min 6 characters)" />
                <input type="password" id="signup-confirm" class="auth-input" placeholder="Confirm Password" />
                <button class="auth-button" onclick="signup()">Create Account</button>
                <div class="auth-toggle">
                    Already have an account? <a onclick="showLogin()">Login</a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>üåø Ecosystem Idle üåø</h1>
        <div class="subtitle">Nurture the wilderness and watch nature flourish</div>

        <!-- User Bar -->
        <div id="user-bar" class="user-bar hidden">
            <div class="user-info">
                <span class="user-email" id="user-email"></span>
                <span class="cloud-status" id="cloud-status">‚òÅÔ∏è Cloud saves enabled</span>
            </div>
            <div class="user-actions">
                <button class="small-button" onclick="manualSave()">üíæ Save Now</button>
                <button class="small-button" onclick="loadFromCloud()">üì• Load</button>
                <button class="small-button danger" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('main')">Main</button>
            <button class="tab" onclick="switchTab('upgrades')">Upgrades</button>
            <button class="tab" onclick="switchTab('stats')">Statistics</button>
            <button class="tab" onclick="switchTab('achievements')">Achievements</button>
        </div>

        <div id="main-tab" class="tab-content active">
            <div class="game-grid">
                <div class="panel">
                    <h2>üå± Resources</h2>
                    <div id="resources"></div>
                </div>

                <div class="panel">
                    <h2>üèóÔ∏è Buildings</h2>
                    <div id="buildings"></div>
                </div>

                <div class="panel">
                    <h2>üî¨ Research</h2>
                    <div id="research"></div>
                </div>

                <div class="panel prestige-panel">
                    <h2>‚ú® Ascension</h2>
                    <div class="prestige-info">
                        <div>Seeds of Rebirth: <strong id="seeds">0</strong></div>
                        <div>Next Ascension Bonus: <strong id="next-bonus">+0%</strong> to all production</div>
                        <div style="margin-top: 10px; font-size: 0.9em;">You will gain <strong id="gain-seeds">0</strong> Seeds of Rebirth</div>
                    </div>
                    <button class="prestige-button" onclick="ascend()" id="ascend-btn">Ascend and Start Anew</button>
                </div>
            </div>
        </div>

        <div id="upgrades-tab" class="tab-content">
            <div class="game-grid">
                <div class="panel">
                    <h2>üîß Purchased Upgrades</h2>
                    <div id="purchased-upgrades"></div>
                </div>
                <div class="panel">
                    <h2>üõí Available Upgrades</h2>
                    <div id="available-upgrades"></div>
                </div>
            </div>
        </div>

        <div id="stats-tab" class="tab-content">
            <div class="panel">
                <h2>üìä Game Statistics</h2>
                <div class="stats-grid" id="stats"></div>
            </div>
        </div>

        <div id="achievements-tab" class="tab-content">
            <div class="panel">
                <h2>üèÜ Achievements</h2>
                <div id="achievements"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, set, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // ‚ö†Ô∏è IMPORTANT: Replace with your Firebase config
        // Get this from Firebase Console > Project Settings > Your apps > SDK setup and configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Make Firebase available globally
        window.firebaseAuth = auth;
        window.firebaseDatabase = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;

        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.currentUser = user;
                document.getElementById('auth-modal').classList.remove('active');
                document.getElementById('user-bar').classList.remove('hidden');
                document.getElementById('user-email').textContent = user.email;
                loadFromCloud();
            } else {
                window.currentUser = null;
                document.getElementById('auth-modal').classList.add('active');
                document.getElementById('user-bar').classList.add('hidden');
            }
        });
    </script>

    <script>
        // Game State
        const game = {
            resources: {
                sunlight: { name: 'Sunlight', amount: 100, rate: 0, icon: '‚òÄÔ∏è' },
                water: { name: 'Water', amount: 50, rate: 0, icon: 'üíß' },
                soil: { name: 'Soil', amount: 30, rate: 0, icon: 'üåç' },
                seeds: { name: 'Seeds', amount: 10, rate: 0, icon: 'üå∞' },
                wood: { name: 'Wood', amount: 0, rate: 0, icon: 'ü™µ' },
                biodiversity: { name: 'Biodiversity', amount: 0, rate: 0, icon: 'ü¶ã' }
            },
            buildings: {
                sunCollector: { name: 'Sun Collector', count: 0, cost: { sunlight: 10 }, produces: { sunlight: 1 }, description: 'Gathers ambient sunlight', icon: 'üåû' },
                rainCatcher: { name: 'Rain Catcher', count: 0, cost: { sunlight: 15, water: 5 }, produces: { water: 0.5 }, description: 'Collects precious rainwater', icon: 'üåßÔ∏è' },
                soilEnricher: { name: 'Compost Pile', count: 0, cost: { water: 10, seeds: 5 }, produces: { soil: 0.3 }, description: 'Enriches the earth', icon: '‚ôªÔ∏è' },
                seedBank: { name: 'Seed Bank', count: 0, cost: { soil: 10, sunlight: 20 }, produces: { seeds: 0.2 }, description: 'Stores and cultivates seeds', icon: 'üè¶' },
                sapling: { name: 'Sapling', count: 0, cost: { seeds: 5, water: 10, soil: 8 }, produces: { wood: 0.1, biodiversity: 0.05 }, description: 'Young trees growing strong', icon: 'üå±' },
                forest: { name: 'Forest Grove', count: 0, cost: { wood: 50, seeds: 30, water: 40 }, produces: { wood: 1, biodiversity: 0.5, seeds: 0.3 }, description: 'A thriving ecosystem', icon: 'üå≤' },
                pond: { name: 'Wildlife Pond', count: 0, cost: { water: 100, soil: 50 }, produces: { biodiversity: 1, water: 0.3 }, description: 'Attracts diverse species', icon: 'üê∏' },
                meadow: { name: 'Wildflower Meadow', count: 0, cost: { seeds: 50, sunlight: 80, soil: 40 }, produces: { biodiversity: 2, seeds: 1 }, description: 'A burst of color and life', icon: 'üå∏' },
                wetland: { name: 'Wetland', count: 0, cost: { water: 200, soil: 100, biodiversity: 10 }, produces: { biodiversity: 3, water: 1, soil: 0.5 }, description: 'Crucial habitat for wildlife', icon: 'ü¶Ü' },
                oldGrowth: { name: 'Old Growth Forest', count: 0, cost: { wood: 500, biodiversity: 50, seeds: 100 }, produces: { wood: 5, biodiversity: 10, sunlight: 2 }, description: 'Ancient trees full of wisdom', icon: 'üå≥' }
            },
            upgrades: {
                efficientCollectors: { name: 'Efficient Collectors', purchased: false, cost: { sunlight: 100 }, effect: { building: 'sunCollector', multiplier: 2 }, description: 'Double Sun Collector output' },
                betterCatchers: { name: 'Better Rain Catchers', purchased: false, cost: { water: 100, sunlight: 150 }, effect: { building: 'rainCatcher', multiplier: 2 }, description: 'Double Rain Catcher output' },
                richCompost: { name: 'Rich Compost', purchased: false, cost: { soil: 50, seeds: 30 }, effect: { building: 'soilEnricher', multiplier: 2 }, description: 'Double Compost Pile output' },
                seedVault: { name: 'Seed Vault', purchased: false, cost: { seeds: 100, wood: 50 }, effect: { building: 'seedBank', multiplier: 2 }, description: 'Double Seed Bank output' },
                fastGrowth: { name: 'Fast Growth Formula', purchased: false, cost: { wood: 100, biodiversity: 20 }, effect: { building: 'sapling', multiplier: 1.5 }, description: '50% more Sapling production' },
                biodiversityBoost: { name: 'Biodiversity Initiative', purchased: false, cost: { biodiversity: 50, seeds: 200 }, effect: { resource: 'biodiversity', multiplier: 1.5 }, description: '50% more biodiversity from all sources' },
                waterCycle: { name: 'Water Cycle Mastery', purchased: false, cost: { water: 300, biodiversity: 30 }, effect: { resource: 'water', multiplier: 1.3 }, description: '30% more water from all sources' },
                photosynthesis: { name: 'Enhanced Photosynthesis', purchased: false, cost: { sunlight: 500, wood: 200 }, effect: { resource: 'sunlight', multiplier: 1.3 }, description: '30% more sunlight from all sources' },
                permaculture: { name: 'Permaculture Design', purchased: false, cost: { soil: 200, water: 200, seeds: 150 }, effect: { building: 'forest', multiplier: 2 }, description: 'Double Forest Grove output' },
                ecosystem: { name: 'Ecosystem Balance', purchased: false, cost: { biodiversity: 100, wood: 300 }, effect: { global: true, multiplier: 1.2 }, description: '20% boost to ALL production' }
            },
            prestige: {
                seeds: 0,
                totalAscensions: 0
            },
            stats: {
                totalClicks: 0,
                totalProduced: {},
                timePlayed: 0,
                buildingsBought: 0
            },
            achievements: {
                firstClick: { name: 'First Click', description: 'Click a resource for the first time', unlocked: false },
                firstBuilding: { name: 'Builder', description: 'Purchase your first building', unlocked: false },
                tenBuildings: { name: 'Architect', description: 'Own 10 buildings total', unlocked: false },
                hundredBuildings: { name: 'City Planner', description: 'Own 100 buildings total', unlocked: false },
                firstUpgrade: { name: 'Researcher', description: 'Purchase your first upgrade', unlocked: false },
                richInBio: { name: 'Biodiversity Champion', description: 'Have 1000 biodiversity', unlocked: false },
                woodStock: { name: 'Lumberjack', description: 'Have 5000 wood', unlocked: false },
                firstAscend: { name: 'Rebirth', description: 'Ascend for the first time', unlocked: false },
                fiveAscend: { name: 'Eternal Cycle', description: 'Ascend 5 times', unlocked: false }
            }
        };

        let isGuest = false;

        // Initialize statistics for all resources
        Object.keys(game.resources).forEach(res => {
            game.stats.totalProduced[res] = 0;
        });

        // Auth Functions
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        function showLogin() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('signup-form').classList.add('hidden');
            document.getElementById('auth-title').textContent = 'Welcome Back';
        }

        function showSignup() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('signup-form').classList.remove('hidden');
            document.getElementById('auth-title').textContent = 'Create Account';
        }

        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showError('Please enter email and password');
                return;
            }

            try {
                await window.signInWithEmailAndPassword(window.firebaseAuth, email, password);
                showSuccess('Logged in successfully!');
            } catch (error) {
                showError(error.message);
            }
        }

        async function signup() {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const confirm = document.getElementById('signup-confirm').value;

            if (!email || !password || !confirm) {
                showError('Please fill all fields');
                return;
            }

            if (password !== confirm) {
                showError('Passwords do not match');
                return;
            }

            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }

            try {
                await window.createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                showSuccess('Account created successfully!');
            } catch (error) {
                showError(error.message);
            }
        }

        async function logout() {
            if (confirm('Are you sure you want to logout? Make sure your game is saved!')) {
                try {
                    await window.signOut(window.firebaseAuth);
                    location.reload();
                } catch (error) {
                    showError(error.message);
                }
            }
        }

        function playAsGuest() {
            isGuest = true;
            document.getElementById('auth-modal').classList.remove('active');
            loadGame();
            updateUI();
        }

        // Cloud Save Functions
        async function saveToCloud() {
            if (!window.currentUser || isGuest) return;

            try {
                const statusEl = document.getElementById('cloud-status');
                statusEl.textContent = '‚òÅÔ∏è Saving...';
                statusEl.className = 'cloud-status saving';

                const userId = window.currentUser.uid;
                const saveData = {
                    game: game,
                    timestamp: Date.now()
                };

                await window.firebaseSet(window.firebaseRef(window.firebaseDatabase, 'saves/' + userId), saveData);

                statusEl.textContent = '‚òÅÔ∏è Saved to cloud';
                statusEl.className = 'cloud-status saved';

                setTimeout(() => {
                    statusEl.textContent = '‚òÅÔ∏è Cloud saves enabled';
                    statusEl.className = 'cloud-status';
                }, 2000);
            } catch (error) {
                console.error('Cloud save error:', error);
                showError('Failed to save to cloud: ' + error.message);
            }
        }

        async function loadFromCloud() {
            if (!window.currentUser || isGuest) {
                loadGame();
                return;
            }

            try {
                const userId = window.currentUser.uid;
                const snapshot = await window.firebaseGet(window.firebaseRef(window.firebaseDatabase, 'saves/' + userId));

                if (snapshot.exists()) {
                    const saveData = snapshot.val();
                    Object.assign(game, saveData.game);
                    showSuccess('Game loaded from cloud!');
                } else {
                    // No cloud save, try local
                    loadGame();
                }

                updateUI();
            } catch (error) {
                console.error('Cloud load error:', error);
                showError('Failed to load from cloud: ' + error.message);
                loadGame(); // Fallback to local
            }
        }

        function manualSave() {
            if (window.currentUser && !isGuest) {
                saveToCloud();
            } else {
                saveGame();
                showSuccess('Game saved locally!');
            }
        }

        // Click resource to gather manually
        function clickResource(resource) {
            const baseAmount = 1;
            const bonus = 1 + (game.prestige.seeds * 0.1);
            game.resources[resource].amount += baseAmount * bonus;
            game.stats.totalClicks++;
            game.stats.totalProduced[resource] = (game.stats.totalProduced[resource] || 0) + baseAmount * bonus;
            checkAchievement('firstClick');
            updateUI();
        }

        // Purchase building
        function buyBuilding(buildingKey) {
            const building = game.buildings[buildingKey];
            const cost = calculateCost(building.cost, building.count);
            
            if (canAfford(cost)) {
                Object.keys(cost).forEach(res => {
                    game.resources[res].amount -= cost[res];
                });
                
                building.count++;
                game.stats.buildingsBought++;
                checkAchievement('firstBuilding');
                checkAchievement('tenBuildings');
                checkAchievement('hundredBuildings');
                updateUI();
            }
        }

        function calculateCost(baseCost, count) {
            const cost = {};
            Object.keys(baseCost).forEach(res => {
                cost[res] = Math.floor(baseCost[res] * Math.pow(1.15, count));
            });
            return cost;
        }

        function canAfford(cost) {
            return Object.keys(cost).every(res => 
                game.resources[res] && game.resources[res].amount >= cost[res]
            );
        }

        function buyUpgrade(upgradeKey) {
            const upgrade = game.upgrades[upgradeKey];
            
            if (!upgrade.purchased && canAfford(upgrade.cost)) {
                Object.keys(upgrade.cost).forEach(res => {
                    game.resources[res].amount -= upgrade.cost[res];
                });
                
                upgrade.purchased = true;
                checkAchievement('firstUpgrade');
                updateUI();
            }
        }

        function calculateRates() {
            Object.keys(game.resources).forEach(res => {
                game.resources[res].rate = 0;
            });

            Object.keys(game.buildings).forEach(buildingKey => {
                const building = game.buildings[buildingKey];
                if (building.count > 0 && building.produces) {
                    Object.keys(building.produces).forEach(res => {
                        let amount = building.produces[res] * building.count;
                        
                        Object.values(game.upgrades).forEach(upgrade => {
                            if (upgrade.purchased && upgrade.effect.building === buildingKey) {
                                amount *= upgrade.effect.multiplier;
                            }
                        });
                        
                        game.resources[res].rate += amount;
                    });
                }
            });

            Object.keys(game.resources).forEach(res => {
                Object.values(game.upgrades).forEach(upgrade => {
                    if (upgrade.purchased && upgrade.effect.resource === res) {
                        game.resources[res].rate *= upgrade.effect.multiplier;
                    }
                });
            });

            Object.values(game.upgrades).forEach(upgrade => {
                if (upgrade.purchased && upgrade.effect.global) {
                    Object.keys(game.resources).forEach(res => {
                        game.resources[res].rate *= upgrade.effect.multiplier;
                    });
                }
            });

            const prestigeBonus = 1 + (game.prestige.seeds * 0.1);
            Object.keys(game.resources).forEach(res => {
                game.resources[res].rate *= prestigeBonus;
            });
        }

        function gameTick() {
            calculateRates();
            
            Object.keys(game.resources).forEach(res => {
                const gain = game.resources[res].rate / 10;
                game.resources[res].amount += gain;
                game.stats.totalProduced[res] = (game.stats.totalProduced[res] || 0) + gain;
            });

            game.stats.timePlayed += 0.1;
            checkResourceAchievements();
            updateUI();
        }

        function formatNumber(num) {
            if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
            return num.toFixed(2);
        }

        function updateUI() {
            const resourcesDiv = document.getElementById('resources');
            resourcesDiv.innerHTML = '';
            Object.entries(game.resources).forEach(([key, res]) => {
                const div = document.createElement('div');
                div.className = 'resource';
                div.onclick = () => clickResource(key);
                div.style.cursor = 'pointer';
                div.innerHTML = `
                    <span class="resource-name">${res.icon} ${res.name}</span>
                    <span>
                        <span class="resource-value">${formatNumber(res.amount)}</span>
                        ${res.rate > 0 ? `<span class="resource-rate">+${formatNumber(res.rate)}/s</span>` : ''}
                    </span>
                `;
                resourcesDiv.appendChild(div);
            });

            const buildingsDiv = document.getElementById('buildings');
            buildingsDiv.innerHTML = '';
            Object.entries(game.buildings).forEach(([key, building]) => {
                const cost = calculateCost(building.cost, building.count);
                const canBuy = canAfford(cost);
                
                const div = document.createElement('div');
                div.className = `building ${!canBuy ? 'disabled' : ''}`;
                
                let productionText = '';
                if (building.produces) {
                    productionText = Object.entries(building.produces).map(([res, amount]) => {
                        let finalAmount = amount;
                        Object.values(game.upgrades).forEach(upgrade => {
                            if (upgrade.purchased && upgrade.effect.building === key) {
                                finalAmount *= upgrade.effect.multiplier;
                            }
                        });
                        return `${game.resources[res].icon}+${formatNumber(finalAmount)}/s`;
                    }).join(', ');
                }
                
                div.innerHTML = `
                    <div class="building-header">
                        <span class="building-name">${building.icon} ${building.name}</span>
                        <span class="building-count">${building.count}</span>
                    </div>
                    <div class="building-description">${building.description}</div>
                    <div class="building-cost">Cost: ${Object.entries(cost).map(([res, amount]) => 
                        `${game.resources[res].icon}${formatNumber(amount)}`).join(', ')}</div>
                    ${productionText ? `<div class="building-production">Produces: ${productionText}</div>` : ''}
                    <button onclick="buyBuilding('${key}')" ${!canBuy ? 'disabled' : ''}>
                        Build
                    </button>
                `;
                buildingsDiv.appendChild(div);
            });

            const researchDiv = document.getElementById('research');
            researchDiv.innerHTML = '';
            const unpurchasedUpgrades = Object.entries(game.upgrades).filter(([_, u]) => !u.purchased).slice(0, 3);
            
            if (unpurchasedUpgrades.length === 0) {
                researchDiv.innerHTML = '<p style="text-align: center; color: #718096; padding: 20px;">All research complete! Check Upgrades tab.</p>';
            } else {
                unpurchasedUpgrades.forEach(([key, upgrade]) => {
                    const canBuy = canAfford(upgrade.cost);
                    const div = document.createElement('div');
                    div.className = `upgrade ${!canBuy ? 'disabled' : ''}`;
                    div.innerHTML = `
                        <div class="upgrade-header">
                            <span class="upgrade-name">üî¨ ${upgrade.name}</span>
                        </div>
                        <div class="upgrade-description">${upgrade.description}</div>
                        <div class="upgrade-cost">Cost: ${Object.entries(upgrade.cost).map(([res, amount]) => 
                            `${game.resources[res].icon}${formatNumber(amount)}`).join(', ')}</div>
                        <button onclick="buyUpgrade('${key}')" ${!canBuy ? 'disabled' : ''}>
                            Research
                        </button>
                    `;
                    researchDiv.appendChild(div);
                });
            }

            updateUpgradesTab();
            updatePrestigeUI();
            updateStatsUI();
            updateAchievementsUI();
        }

        function updateUpgradesTab() {
            const purchasedDiv = document.getElementById('purchased-upgrades');
            const availableDiv = document.getElementById('available-upgrades');
            
            const purchased = Object.entries(game.upgrades).filter(([_, u]) => u.purchased);
            const available = Object.entries(game.upgrades).filter(([_, u]) => !u.purchased);
            
            purchasedDiv.innerHTML = '';
            if (purchased.length === 0) {
                purchasedDiv.innerHTML = '<p style="text-align: center; color: #718096; padding: 20px;">No upgrades purchased yet</p>';
            } else {
                purchased.forEach(([key, upgrade]) => {
                    const div = document.createElement('div');
                    div.className = 'upgrade';
                    div.innerHTML = `
                        <div class="upgrade-header">
                            <span class="upgrade-name">‚úÖ ${upgrade.name}</span>
                        </div>
                        <div class="upgrade-description">${upgrade.description}</div>
                    `;
                    purchasedDiv.appendChild(div);
                });
            }
            
            availableDiv.innerHTML = '';
            if (available.length === 0) {
                availableDiv.innerHTML = '<p style="text-align: center; color: #718096; padding: 20px;">All upgrades purchased!</p>';
            } else {
                available.forEach(([key, upgrade]) => {
                    const canBuy = canAfford(upgrade.cost);
                    const div = document.createElement('div');
                    div.className = `upgrade ${!canBuy ? 'disabled' : ''}`;
                    div.innerHTML = `
                        <div class="upgrade-header">
                            <span class="upgrade-name">üî¨ ${upgrade.name}</span>
                        </div>
                        <div class="upgrade-description">${upgrade.description}</div>
                        <div class="upgrade-cost">Cost: ${Object.entries(upgrade.cost).map(([res, amount]) => 
                            `${game.resources[res].icon}${formatNumber(amount)}`).join(', ')}</div>
                        <button onclick="buyUpgrade('${key}')" ${!canBuy ? 'disabled' : ''}>
                            Research
                        </button>
                    `;
                    availableDiv.appendChild(div);
                });
            }
        }

        function updatePrestigeUI() {
            const biodiversity = game.resources.biodiversity.amount;
            const gainSeeds = Math.floor(Math.sqrt(biodiversity) / 10);
            const nextBonus = (game.prestige.seeds + gainSeeds) * 10;
            
            document.getElementById('seeds').textContent = game.prestige.seeds;
            document.getElementById('next-bonus').textContent = `+${nextBonus}%`;
            document.getElementById('gain-seeds').textContent = gainSeeds;
            
            const ascendBtn = document.getElementById('ascend-btn');
            ascendBtn.disabled = gainSeeds === 0;
        }

        function ascend() {
            const biodiversity = game.resources.biodiversity.amount;
            const gainSeeds = Math.floor(Math.sqrt(biodiversity) / 10);
            
            if (gainSeeds === 0) return;
            
            if (confirm(`Are you sure? You will lose all progress but gain ${gainSeeds} Seeds of Rebirth, giving you +${(game.prestige.seeds + gainSeeds) * 10}% production bonus.`)) {
                game.prestige.seeds += gainSeeds;
                game.prestige.totalAscensions++;
                
                checkAchievement('firstAscend');
                checkAchievement('fiveAscend');
                
                Object.keys(game.resources).forEach(res => {
                    game.resources[res].amount = res === 'sunlight' ? 100 : res === 'water' ? 50 : res === 'soil' ? 30 : res === 'seeds' ? 10 : 0;
                    game.resources[res].rate = 0;
                });
                
                Object.keys(game.buildings).forEach(building => {
                    game.buildings[building].count = 0;
                });
                
                Object.keys(game.upgrades).forEach(upgrade => {
                    game.upgrades[upgrade].purchased = false;
                });
                
                updateUI();
            }
        }

        function updateStatsUI() {
            const statsDiv = document.getElementById('stats');
            const totalBuildingCount = Object.values(game.buildings).reduce((sum, b) => sum + b.count, 0);
            const upgradePurchased = Object.values(game.upgrades).filter(u => u.purchased).length;
            const totalUpgrades = Object.keys(game.upgrades).length;
            
            statsDiv.innerHTML = `
                <div class="stat-box">
                    <div class="stat-label">Time Played</div>
                    <div class="stat-value">${formatTime(game.stats.timePlayed)}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Total Clicks</div>
                    <div class="stat-value">${formatNumber(game.stats.totalClicks)}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Buildings Owned</div>
                    <div class="stat-value">${totalBuildingCount}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Upgrades</div>
                    <div class="stat-value">${upgradePurchased}/${totalUpgrades}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Total Ascensions</div>
                    <div class="stat-value">${game.prestige.totalAscensions}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Production Bonus</div>
                    <div class="stat-value">+${game.prestige.seeds * 10}%</div>
                </div>
            `;
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${hours}h ${minutes}m ${secs}s`;
        }

        function updateAchievementsUI() {
            const achievementsDiv = document.getElementById('achievements');
            achievementsDiv.innerHTML = '';
            
            Object.entries(game.achievements).forEach(([key, achievement]) => {
                const div = document.createElement('div');
                div.className = `achievement ${achievement.unlocked ? 'unlocked' : ''}`;
                div.innerHTML = `
                    <div class="achievement-name">${achievement.unlocked ? 'üèÜ' : 'üîí'} ${achievement.name}</div>
                    <div class="achievement-desc">${achievement.description}</div>
                `;
                achievementsDiv.appendChild(div);
            });
        }

        function checkAchievement(key) {
            if (!game.achievements[key].unlocked) {
                game.achievements[key].unlocked = true;
            }
        }

        function checkResourceAchievements() {
            if (game.resources.biodiversity.amount >= 1000) checkAchievement('richInBio');
            if (game.resources.wood.amount >= 5000) checkAchievement('woodStock');
            
            const totalBuildingCount = Object.values(game.buildings).reduce((sum, b) => sum + b.count, 0);
            if (totalBuildingCount >= 10) checkAchievement('tenBuildings');
            if (totalBuildingCount >= 100) checkAchievement('hundredBuildings');
            
            if (game.prestige.totalAscensions >= 5) checkAchievement('fiveAscend');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
        }

        function saveGame() {
            localStorage.setItem('ecosystemIdleSave', JSON.stringify(game));
        }

        function loadGame() {
            const saved = localStorage.getItem('ecosystemIdleSave');
            if (saved) {
                const loadedGame = JSON.parse(saved);
                Object.assign(game, loadedGame);
            }
        }

        // Make functions global
        window.showLogin = showLogin;
        window.showSignup = showSignup;
        window.login = login;
        window.signup = signup;
        window.logout = logout;
        window.playAsGuest = playAsGuest;
        window.manualSave = manualSave;
        window.loadFromCloud = loadFromCloud;
        window.clickResource = clickResource;
        window.buyBuilding = buyBuilding;
        window.buyUpgrade = buyUpgrade;
        window.ascend = ascend;
        window.switchTab = switchTab;

        // Initialize game
        setInterval(gameTick, 100);
        setInterval(() => {
            if (window.currentUser && !isGuest) {
                saveToCloud();
            } else {
                saveGame();
            }
        }, 30000); // Auto-save every 30 seconds
    </script>
</body>
</html>